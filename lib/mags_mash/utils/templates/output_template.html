<html>
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css?family=Oxygen:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/dt-1.10.18/b-1.5.4/b-colvis-1.5.4/b-html5-1.5.4/b-print-1.5.4/datatables.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" 
    integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
    integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
    crossorigin=""></script>

    <style>
    /*CSS styling*/

    *{font-family: 'Oxygen', Helvetica, sans-serif;}


    ul{
        list-style-type: none;
    }

    .caret {
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none
    }

    .caret::before{
        content: "\25B6";
        color: black;
        display: inline-block;
        margin-right: 8px;
    }

    .caret-down::before{
        -ms-transform: rotate(90deg);
        -webkit-transform: rotate(90deg);
        transform: rotate(90deg);
    }

    .nested {
        display: none
    }

    .active {
        display: block;
    }

    .tab {
        overflow: hidden;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
    }
    .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.0s;
        font-size: 17px;
    }

    .tab button:hover{
        background-color: #ddd;
    }

    .tab button.active{
        background-color: #ccc;
    }

    .node rect {
        cursor: pointer;
        fill: #fff;
        fill-opacity: 0.5;
        stroke: #3182bd;
        stroke-width: 1.5px;
    }

    .node text {
        font: 12px;
        pointer-events: none;
    }

    .link {
        fill: none;
        stroke: #9ecae1;
        stroke-width: 1.5px;
    }

    </style>

</head>
<!-- HTML below -->
<body>
    <div class='tab'>
        <button class="tablinks" onclick="openTab(event, 'stats')" id="defaultOpen">List View</button>
        <button class="tablinks" onclick="openTab(event, 'treetab')">Ecosystem Tree</button>
        <button class="tablinks" onclick="openTab(event, 'maptab')">Map</button>
    </div>

    <!--
    Recursive Tree structure below, fill in with tree


    going to replace this tree thing with html 
    -->
    <div id="treetab" class="tabcontent" style="width: 100%; height: 100%;">
        <div id="treeid" style="width: 100%; height: 100%;"></div>
    </div>
<!--         {%- for t in tree recursive %}
            {%- if t.children -%}
            <li><span class="caret">{{t.name}}</span>
                <ul class="nested">{{ loop(t.children) }} </ul>
            </li>
            {%- else -%}
            <li>{{t.name}}</li>
            {%- endif %}
        {%- endfor %}
    </div> -->
    <!--
    Statistics List view
    -->
    <div id='stats' class="tabcontent">
        <table id='stats_table' class='table table-striped table-bordered'>
            <thead>
                <tr>
                    <td>Distance</td>
                    <td>MAG ID</td>
                    <td>KBase ID</td>
                    <td>GOLD Analysis Project ID</td>
                    <td>GOLD Sequencing Project ID</td>
                    <td>IMG Genome ID</td>
                    <td>Completeness</td>
                    <td>Contamination</td>
                    <td>MIMAG</td>
                    <td>Project/Study Name</td>
                </tr>
            </thead>
            <tbody>
                {% for item in stats %}
                <tr>
                    <td class="sorting_1">{{item.dist}}</td>
                    <td>{{item.mag_id}}</td>
                    <td>{{item.kb_id}}</td>
                    <td>
                        <a href="{{ 'https://gold.jgi.doe.gov/analysis_project?id=%s'%item.GOLD_Analysis_ID }}" target="_blank">{{item.GOLD_Analysis_ID}}</a>
                    </td>
                    <td>
                        <a href="{{ 'https://gold.jgi.doe.gov/project?id=%s'%item.GOLD_Sequencing_ID }}" target="_blank">{{item.GOLD_Sequencing_ID}}</a>
                    </td>
                    <td>{{item.IMG_Genome_ID}}</td>
                    <td>{{item.completeness}}</td>
                    <td>{{item.contamination}}</td>
                    <td>{{item.MIMAG}}</td>
                    <td>{{item.project}}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>    
    </div>

    <div id="maptab" class="tabcontent">
        <div id="mapid" style="height: 88%;"></div>
    </div>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/dt-1.10.18/b-1.5.4/b-colvis-1.5.4/b-html5-1.5.4/b-print-1.5.4/datatables.min.js"></script>

    <script>
        $(document).ready( function () {
            $('.table').DataTable({
                'dom': "<'row'<'col-sm-6'B><'col-sm-6'f>>t<'row'<'col-sm-4'i><'col-sm-8'p>>",
                'buttons': ['copy', 'csv', 'print', 'colvis'],
            });
        } );
    </script>

    <script>

        var markers={{ markers|safe }};
        var mymap = new L.map("mapid").setView([37.87, -122.25],7);

        // create the tile layer with correct attribution
        var osmUrl='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        var osmAttrib='Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
        var osm = new L.TileLayer(osmUrl, {attribution: osmAttrib}).addTo(mymap);

        for (i=0;i<markers.length;i++) {
            var marker = new L.marker([markers[i].lat, markers[i].lng]).addTo(mymap).bindPopup("<h3>"+markers[i].name+"</h3>"+markers[i].details);
        }
        
    </script> 

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script>
        var tree = {{ tree|safe }}
        var margin = {top: 30, right: 20, bottom: 30, left: 20},
            width = 960,
            barHeight = 30,
            barWidth = (width - margin.left - margin.right) * 0.8;

        var i = 0,
            duration = 200,
            root;

        var diagonal = d3.linkHorizontal()
            .x(function(d) { return d.y; })
            .y(function(d) { return d.x; });

        var svg = d3.select("treeid").append("svg")
            .attr("width", width) // + margin.left + margin.right)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        root = d3.hierarchy(tree);
        root.x0 = 0;
        root.y0 = 0;
        update(root)

        function update(source) {

            // Compute the flattened node list.
            var nodes = root.descendants();

            var height = Math.max(500, nodes.length * barHeight + margin.top + margin.bottom);

            d3.select("svg").transition()
                .duration(duration)
                .attr("height", height);

            d3.select(self.frameElement).transition()
                .duration(duration)
                .style("height", height + "px");

            // Compute the "layout". TODO https://github.com/d3/d3-hierarchy/issues/67
            var index = -1;
            root.eachBefore(function(n) {
                n.x = ++index * barHeight;
                n.y = n.depth * 20;
            });

            // Update the nodes…
            var node = svg.selectAll(".node")
                .data(nodes, function(d) { return d.id || (d.id = ++i); });

            var nodeEnter = node.enter().append("g")
                .attr("class", "node")
                .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
                .style("opacity", 0);

            // Enter any new nodes at the parent's previous position.
            nodeEnter.append("rect")
                .attr("y", -barHeight / 2)
                .attr("height", barHeight)
                .attr("width", function(d){
                    console.log(d)
                    return barWidth - d.depth * margin.left
                })
                .style("fill", color)
                .on("click", click);

            nodeEnter.append("text")
                .attr("dy", 3.5)
                .attr("dx", 5.5)
                .text(function(d) { return d.data.name; });

            nodeEnter.append("text")
                .attr('dy', 3.5)
                .attr('dx', function(d){return barWidth - 30 - d.depth * margin.left})
                .style("fill", "#9b9b9b")
                .text(function(d) {return d.data.count})

            // Transition nodes to their new position.
            nodeEnter.transition()
                .duration(duration)
                .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
                .style("opacity", 1);

            node.transition()
                .duration(duration)
                .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
                .style("opacity", 1)
                .select("rect")
                .style("fill", color);

            // Transition exiting nodes to the parent's new position.
            node.exit().transition()
                .duration(duration)
                .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
                .style("opacity", 0)
                .remove();

            // Stash the old positions for transition.
            root.each(function(d) {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        // Toggle children on click.
        function click(d) {
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            update(d);
        }

        function color(d) {
            return d._children ? "#7ab9ff" : d.children ? "#7ab9ff" : "#badaff";
        }

    </script>

<!--     <script>
        var toggler = document.getElementsByClassName("caret");
        var i;

        for (i = 0; i < toggler.length; i++) {
          toggler[i].addEventListener("click", function() {
            this.parentElement.querySelector(".nested").classList.toggle("active");
            this.classList.toggle("caret-down");
          });
        }
    </script> -->

    <script>
        function openTab(evt, name) {
            // Declare all variables
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Get all elements with class="tablinks" and remove the class "active"
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }  

            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(name).style.display = "block";
            evt.currentTarget.className += " active";   
        }
        document.getElementById("defaultOpen").click();
    </script>
</body>
</html>
