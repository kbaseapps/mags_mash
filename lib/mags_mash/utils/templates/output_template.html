<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/dt-1.10.18/b-1.5.4/b-colvis-1.5.4/b-html5-1.5.4/b-print-1.5.4/datatables.min.css"/>
    <link rel="stylesheet" type="text/css" href="leaflet/leaflet.css" />

    <style>
    /*CSS styling*/

    ul{
        list-style-type: none;
    }

    .caret {
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none
    }

    .caret::before{
        content: "\25B6";
        color: black;
        display: inline-block;
        margin-right: 8px;
    }

    .caret-down::before{
        -ms-transform: rotate(90deg);
        -webkit-transform: rotate(90deg);
        transform: rotate(90deg);
    }

    .nested {
        display: none
    }

    .active {
        display: block;
    }

    .tab {
        overflow: hidden;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
    }
    .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.0s;
        font-size: 17px;
    }

    .tab button:hover{
        background-color: #ddd;
    }

    .tab button.active{
        background-color: #ccc;
    }

    </style>

</head>
<!-- HTML below -->
<body>
    <div class='tab'>
        <button class="tablinks" onclick="openTab(event, 'stats')" id="defaultOpen">List View</button>
        <button class="tablinks" onclick="openTab(event, 'tree')">Ecosystem Tree</button>
        <button class="tablinks" onclick="openTab(event, 'map')">Map</button>
    </div>

    <!--
    Recursive Tree structure below, fill in with tree=
    -->
    <div id="tree" class="tabcontent">
        {%- for t in tree recursive %}
            {%- if t.children -%}
            <li><span class="caret">{{t.name}}</span>
                <ul class="nested">{{ loop(t.children) }} </ul>
            </li>
            {%- else -%}
            <li>{{t.name}}</li>
            {%- endif %}
        {%- endfor %}
    </div>
    <!--
    Statistics List view
    -->
    <div id='stats' class="tabcontent">
        <table id='stats_table' class='table table-striped table-bordered dataTable' style="width:height%" role="grid">
            <thead>
                <tr>
                    <th class="sorting" aria-controls="stats_table" aria-sort="ascending">Distance</th>
                    <th class="sorting" aria-controls="stats_table">MAG ID</th>
                    <th class="sorting" aria-controls="stats_table">KBase ID</th>
                    <th class="sorting" aria-controls="stats_table">GOLD Analysis Project ID</th>
                    <th class="sorting" aria-controls="stats_table">GOLD Sequencing Project ID</th>
                    <th class="sorting" aria-controls="stats_table">IMG Genome ID</th>
                    <th class="sorting" aria-controls="stats_table">Completeness</th>
                    <th class="sorting" aria-controls="stats_table">Contamination</th>
                    <th class="sorting" aria-controls="stats_table">MIMAG</th>
                    <th class="sorting" aria-controls="stats_table">Project/Study Name</th>
                </tr>
            </thead>
            <tbody>
                {% for item in stats %}
                <tr>
                    <td class="sorting_1">{{item.dist}}</td>
                    <td>{{item.mag_id}}</td>
                    <td>{{item.kb_id}}</td>
                    <td>
                        <a href="{{ 'https://gold.jgi.doe.gov/analysis_project?id=%s'%item.GOLD_Analysis_ID }}" target="_blank">{{item.GOLD_Analysis_ID}}</a>
                    </td>
                    <td>
                        <a href="{{ 'https://gold.jgi.doe.gov/project?id=%s'%item.GOLD_Sequencing_ID }}" target="_blank">{{item.GOLD_Sequencing_ID}}</a>
                    </td>
                    <td>{{item.IMG_Genome_ID}}</td>
                    <td>{{item.completeness}}</td>
                    <td>{{item.contamination}}</td>
                    <td>{{item.MIMAG}}</td>
                    <td>{{item.project}}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>    
    </div>

    <div id="map" style="height: 90%; background-color: pink;" class="tabcontent"></div>

    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="leaflet/leaflet.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4-4.1.1/jq-3.3.1/dt-1.10.18/b-1.5.4/b-colvis-1.5.4/b-html5-1.5.4/b-print-1.5.4/datatables.min.js"></script>

    <script>
        $(document).ready( function () {
            $('.table').DataTable({
                'dom': "<'row'<'col-sm-6'B><'col-sm-6'f>>t<'row'<'col-sm-4'i><'col-sm-8'p>>",
                'buttons': ['copy', 'csv', 'print', 'colvis'],
            });
        } );
    </script>

    <script>

        var markers={{ markers|safe }};
        var map = new L.map("map").setView(new L.LatLng(37.87, -122.25),7);

        // create the tile layer with correct attribution
        var osmUrl='https://{s}.tile.osm.org/{z}/{x}/{y}.png';
        var osmAttrib='Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors';
        var osm = new L.TileLayer(osmUrl, {minZoom: 3, maxZoom: 12, attribution: osmAttrib});

        map.addTo(osm)

        for (i=0;i<markers.length;i++) {
            L.marker([markers[i].lat, markers[i].lng]).addTo(map).bindPopup("<h3>"+markers[i].name+"</h3>"+markers[i].details);
            // var plotll = new L.LatLng(markers[i].lat,markers[i].lng, true);
            // var plotmark = new L.marker(plotll);
            // plotmark.data=markers[i];
            // map.addLayer(plotmark);
        }

        initmap();
        
    </script>

    <script>
        var toggler = document.getElementsByClassName("caret");
        var i;

        for (i = 0; i < toggler.length; i++) {
          toggler[i].addEventListener("click", function() {
            this.parentElement.querySelector(".nested").classList.toggle("active");
            this.classList.toggle("caret-down");
          });
        }
    </script>

    <script>
        function openTab(evt, name) {
            // Declare all variables
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Get all elements with class="tablinks" and remove the class "active"
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }  

            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(name).style.display = "block";
            evt.currentTarget.className += " active";   
        }
        document.getElementById("defaultOpen").click();
    </script>
</body>
</html>
